{% extends "index.html" %}

{% load i18n %}
{% load account socialaccount %}

{% block head_title %}{% trans "Sign In" %}{% endblock %}

{% block content %}

<h1>Booking for {{ room.name }}</h1>

{% if user.is_authenticated %}
    <form id="booking-form" method="POST" action=".">
        {% csrf_token %}
        {{ form.as_p }}
        <input type="hidden" id="start_date" name="start_date">
        <input type="hidden" id="end_date" name="end_date">
        <button type="submit" id="submit-button" disabled>Submit Booking</button>
    </form>

    <div id="calendar"></div>

    <!-- Availability data passed to JS from Django -->
    <script id="availability-data" type="application/json">
        {{ availability_data|safe }}
    </script>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Retrieve the availability data from the script tag
            let availabilityData = JSON.parse(document.getElementById('availability-data').textContent);

            // Reference the calendar element in your HTML
            let calendarEl = document.getElementById('calendar');

            // Initialize FullCalendar with the room availability data
            let calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                selectable: true,  // Allow users to select dates
                selectMirror: true,  // Shows a placeholder while selecting a date range
                events: availabilityData,  // Populate the calendar with availability data
                selectOverlap: function(event) {
                    // Prevent selecting dates marked as 'UNAVAILABLE'
                    return event.title === 'AVAILABLE';
                },
                select: function(info) {
                    // Handle the selection of available date range
                    let startDate = info.startStr;
                    let endDate = info.endStr;

                    // Set the start and end dates in the form
                    document.getElementById('start_date').value = startDate;
                    document.getElementById('end_date').value = endDate;

                    // Enable the submit button
                    document.getElementById('submit-button').disabled = false;
                },
                eventDidMount: function(info) {
                    // Style the unavailable dates with a red background
                    if (info.event.title === 'UNAVAILABLE') {
                        info.el.style.backgroundColor = '#dc3545';  // Red for unavailable
                    } else {
                        info.el.style.backgroundColor = '#28a745';  // Green for available
                    }
                }
            });

            // Render the calendar
            calendar.render();
        });
    </script>
{% else %}
    <h1>Only signed in users can book a room at The Castle! Please Create an Account or Sign in to make your booking.</h1>
{% endif %}

{% endblock %}